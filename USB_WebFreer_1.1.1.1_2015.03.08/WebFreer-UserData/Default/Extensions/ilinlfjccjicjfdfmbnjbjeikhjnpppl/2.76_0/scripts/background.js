function initialize(a,b,c,d){var e=0;if(b!=undefined){clearInterval(intTimer);token=b;limit=c;SC.initialize({client_id:"2b161e5544f1f7f4cab5ff3c76c6c7b8",access_token:token});intTimer=setInterval(updateTracks,60*d*1e3);if(a===1){for(e=0;e<incData.length;e++){incData[e].length=0}for(e=0;e<favData.length;e++){favData[e].length=0}fetchTracks("/me/activities/tracks","inc",0,0);fetchTracks("/me/favorites","fav",0,0)}}else{clearInterval(intTimer)}}function pushData(a,b,c,d,e,f){if(b==="push"){a[0].push(c);a[1].push(d);a[2].push(e);a[3].push(f)}if(b==="unshift"){a[0].unshift(c);a[1].unshift(d);a[2].unshift(e);a[3].unshift(f)}}function crunchCollection(a,b,c,d){$.each(a,function(){var a=this.origin;if(a.title!==undefined){var b="push";var d=formatTrack(a.title,a.user.permalink,a.user.username,a.waveform_url,a.permalink_url,a.artwork_url,a.download_url,a.purchase_url,a.genre,a.commentable);if($.inArray(d,incData[0])<0&&$.inArray(a.id,incData[3])<0){if(c===1){tNew++;b="unshift"}pushData(incData,b,d,a.stream_url,a.user_favorite,a.id)}}})}function crunchIncoming(a,b,c,d){responseCount=0;responseMax=a.length;for(var e=0;e<a.length;e++){if(a[e].title!==undefined&&a[e].streamable){var f="push";var g=formatTrack(a[e].title,a[e].user.permalink,a[e].user.username,a[e].waveform_url,a[e].permalink_url,a[e].artwork_url,a[e].download_url,a[e].purchase_url,a[e].genre,a[e].commentable);if(b==="fav"){if($.inArray(g,favData[0])<0&&$.inArray(a[e].id,favData[3])<0){if(c===1){fNew++;f="unshift"}pushData(favData,f,g,a[e].stream_url,a[e].user_favorite,a[e].id)}}else{if($.inArray(g,miscData[0])<0&&$.inArray(a[e].id,miscData[3])<0){var h=a[e].stream_url;var i=a[e].id;if(c===1){miscNew++;f="unshift"}pushData(miscData,f,g,h,0,i);SC.get("/me/favorites/"+a[e].id,function(a,b){if(b){}else{for(var c=0;c<miscData[3].length;c++){if(miscData[3][c]===a.id){miscData[2][c]=1}}}if(responseCount==responseMax-1){views=chrome.extension.getViews({type:"popup"});if(views[0]){chrome.extension.sendRequest({requestlist:"readymoreartists"})}}responseCount++})}}}}}function fetchTracks(a,b,c,d){var e=limit;if(d===1){if(b==="inc"){e=incData[0].length+parseInt(limit)}else if(b==="fav"){offset=favData[0].length}else{offset=miscData[0].length}}else{offset=0}SC.get(a+"?limit="+e+"&offset="+offset,function(a){if(!a.collection){crunchIncoming(a,b,c,d)}else{crunchCollection(a.collection,b,c,d)}if(b==="inc"){if(tNew>0){tNewCount=tNewCount+tNew;chrome.browserAction.setBadgeText({text:tNewCount+""});if(view==="inc"){viewlength=incData[0].length;current=inBounds(parseInt(current)+parseInt(tNew),viewlength)}tNew=0;views=chrome.extension.getViews({type:"popup"});if(views[0]){chrome.extension.sendRequest({requestlist:"new"})}}if(c===0&&d!==1){viewlength=incData[0].length;trackPlayback(0,view)}if(d===1){views=chrome.extension.getViews({type:"popup"});if(views[0]){chrome.extension.sendRequest({requestlist:"readymoreinc"})}}}else if(b==="fav"){if(view==="fav"){viewlength=favData[0].length}if(fNew>0){if(view==="fav"){current=inBounds(parseInt(current,10)+parseInt(fNew,10),viewlength)}fNew=0;views=chrome.extension.getViews({type:"popup"});if(views[0]){chrome.extension.sendRequest({requestlist:"new"})}}if(d===1){views=chrome.extension.getViews({type:"popup"});if(views[0]){chrome.extension.sendRequest({requestlist:"readymorefav"})}}}else{if(view!=="fav"&&view!=="inc"){viewlength=misData[0].length}if(miscNew>0){if(view!=="fav"&&view!=="inc"){current=inBounds(parseInt(current,10)+parseInt(miscNew,10),viewlength)}miscNew=0;views=chrome.extension.getViews({type:"popup"});if(views[0]){chrome.extension.sendRequest({requestlist:"new"})}}}})}function updateTracks(){fetchTracks("/me/activities/tracks","inc",1,0);fetchTracks("/me/favorites","fav",1,0)}function formatTrack(a,b,c,d,e,f,g,h,i,j){var k='<a href="#" class="tLink" id="'+d+","+e+","+f+","+g+","+h+","+i+","+j+","+b+","+c+'">'+a+" by "+c+"</a>";return k}function inBounds(a,b){if(a>b-1){a=b-1}return parseInt(a,10)}function trackPlayback(a,b,c){var d;$("#stream").empty();if(b==="inc"){d=incData[1][a];view="inc"}else if(b==="fav"){d=favData[1][a];view="fav"}else{d=miscData[1][a];view=b}current=inBounds(parseInt(a),viewlength);buffered=0;buffTimer=setTimeout(tShift,500);$("#stream").html('<audio id="playing" name="playing" src="'+d+'?client_id=2b161e5544f1f7f4cab5ff3c76c6c7b8" preload="auto"></audio>');$("#playing")[0].addEventListener("ended",function(){endPlayback("next")},false);$("#playing").bind("timeupdate",tShift);if(c){autoplay=1}}function tShift(a){if($("#playing")[0].readyState>1){if($("#playing")[0].paused&&autoplay===1){autoplay=0;$("#playing")[0].play();a=1}var b=$("#playing")[0].currentTime/$("#playing")[0].duration*426;if(b<1){b=1}buffered=$("#playing")[0].buffered.end($("#playing")[0].buffered.length-1)/$("#playing")[0].duration*426;var c=Math.floor(Math.floor($("#playing")[0].currentTime)/60),d=Math.floor($("#playing")[0].currentTime)%60,e=Math.floor(Math.floor($("#playing")[0].duration)/60),f=Math.floor($("#playing")[0].duration)%60;if(d<10){d="0"+d}if(f<10){f="0"+f}views=chrome.extension.getViews({type:"popup"});if(views[0]){chrome.extension.sendRequest({requestlist:"buffer,"+Math.round(buffered)+","+Math.round(b)+","+c+"."+d+" / "+e+"."+f})}}if($("#playing")[0].paused&&buffered!==426){buffTimer=setTimeout(tShift,500)}if(a===1){views=chrome.extension.getViews({type:"popup"});if($("#playing")[0].paused){if(views[0]){chrome.extension.sendRequest({requestlist:"playstate,play"})}}else{if(views[0]){chrome.extension.sendRequest({requestlist:"playstate,pause"})}}}}function endPlayback(a){if(looping==="one"){a=parseInt(current)}else if(looping==="all"){a=parseInt(current)+1;if(a>=viewlength){a=0}}else{a=parseInt(current)+1}if(localStorage.autoplay==="1"&&a<viewlength){current=inBounds(parseInt(a,10),viewlength);views=chrome.extension.getViews({type:"popup"});if(views[0]){chrome.extension.sendRequest({requestlist:"next,"+current})}trackPlayback(current,view,1)}}var tNew=0,tNewCount=0,fNew=0,autoplay=0,comments=0,view="inc",viewlength=0,misc=0,miscNew=0,miscProper="",responseCount=0,responseMax=0,looping="off",miscString="";var incData=[[],[],[],[]];var favData=[[],[],[],[]];var miscData=[[],[],[],[]];var token,limit,intTimer,buffered,buffTimer,current=0,linkcount,inc,views;initialize(0,localStorage.token,localStorage.limit,localStorage.interval);$(function(){if(token!==undefined){fetchTracks("/me/activities/tracks","inc",0,0);fetchTracks("/me/favorites","fav",0,0)}});chrome.extension.onRequest.addListener(function(a,b,c){var d;if(a.requestlist.substring(0,4)==="give"){inc=a.requestlist.split(",");if(inc[1]==="startup"){if(view==="inc"){tNewCount=0;chrome.browserAction.setBadgeText({text:""});c({sendlist:incData[0]})}if(view==="fav"){c({sendlist:favData[0]})}else{if(view===misc){c({sendlist:miscData[0]})}}}else if(inc[1]==="inc"){tNewCount=0;chrome.browserAction.setBadgeText({text:""});c({sendlist:incData[0]})}else if(inc[1]==="fav"){c({sendlist:favData[0]})}else{if(inc[1]===misc){c({sendlist:miscData[0]})}else{miscData=[[],[],[],[]];misc=inc[1];miscString="/users/"+inc[1]+"/tracks";fetchTracks(miscString,"artist",0,1);c({})}}}else if(a.requestlist.substring(0,6)==="proper"){miscProper=a.requestlist.split(",")[1];c({})}else if(a.requestlist==="getproper"){c({sendlist:miscProper})}else if(a.requestlist==="view"){c({sendlist:view})}else if(a.requestlist.substring(0,6)==="update"){inc=a.requestlist.split(",");initialize(1,inc[1],inc[2],inc[3]);c({})}else if(a.requestlist==="reset"){initialize(0,localStorage.token,localStorage.limit,localStorage.interval);c({})}else if(a.requestlist==="forceshift"){tShift(1);c({})}else if(a.requestlist==="playback"){if(buffered>0){if($("#playing")[0].paused){clearTimeout(buffTimer);$("#playing")[0].play()}else{if(buffered!==426){buffTimer=setTimeout(tShift,500)}$("#playing")[0].pause()}autoplay=0}c({})}else if(a.requestlist.substring(0,5)==="scrub"){inc=a.requestlist.split(",");if(buffered<inc[1]){$("#playing")[0].currentTime=buffered/426*$("#playing")[0].duration}else{$("#playing")[0].currentTime=inc[1]/426*$("#playing")[0].duration}c({})}else if(a.requestlist.substring(0,12)==="changetracks"){inc=a.requestlist.split(",");if(inc[1]==="inc"){viewlength=incData[0].length}else if(inc[1]==="fav"){viewlength=favData[0].length}else{viewlength=miscData[0].length}current=inBounds(parseInt(inc[2],10),viewlength);trackPlayback(parseInt(inc[2],10),inc[1],1);c({})}else if(a.requestlist==="datastring"){if(view==="inc"){c({sendlist:incData[0][current]})}else if(view==="fav"){c({sendlist:favData[0][current]})}else{c({sendlist:miscData[0][current]})}}else if(a.requestlist==="current"){c({sendlist:current})}else if(a.requestlist==="playview"){c({sendlist:view})}else if(a.requestlist==="favinfo"){if(view==="inc"){c({sendlist:incData[2][current]})}else if(view==="fav"){c({sendlist:favData[2][current]})}else{c({sendlist:miscData[2][current]})}}else if(a.requestlist==="loopAll"){looping="all";c({})}else if(a.requestlist==="loopOne"){looping="one";c({})}else if(a.requestlist==="loopNone"){looping="off";c({})}else if(a.requestlist==="loopStatus"){c({sendlist:looping})}else if(a.requestlist.substr(0,8)==="loadmore"){if(a.requestlist.substr(8)==="inc"){fetchTracks("/me/activities/tracks","inc",0,1)}else if(a.requestlist.substr(8)==="fav"){fetchTracks("/me/favorites","fav",0,1)}else{fetchTracks(miscString,"artist",0,1)}}else if(a.requestlist==="saveFavorite"){var e;if(view==="inc"){incData[2][current]=1;e=incData[3][current]}else if(view==="fav"){favData[2][current]=1;e=favData[3][current]}else{miscData[2][current]=1;e=miscData[3][current]}d=new XMLHttpRequest;d.open("PUT","https://api.soundcloud.com/me/favorites/"+e+".json?oauth_token="+localStorage.token,true);d.send(null);c({})}else if(a.requestlist==="removeFavorite"){var e;if(view==="inc"){incData[2][current]=0;e=incData[3][current]}else if(view==="fav"){favData[2][current]=0;e=favData[3][current]}else{miscData[2][current]=0;e=miscData[3][current]}incData[2][current]=false;d=new XMLHttpRequest;d.open("DELETE","https://api.soundcloud.com/me/favorites/"+e+".json?oauth_token="+localStorage.token,true);d.send(null);c({})}else if(a.requestlist==="comments"){var f,g;var h="";var i=localStorage.comopt;if(i===undefined){i=20}if(view==="inc"){g=incData[3][current]}else if(view==="fav"){g=favData[3][current]}else{g=miscData[3][current]}SC.get("/tracks/"+g+"/comments?limit="+i,function(a){for(f=0;f<a.length;f++){var b='<a href="'+a[f].user.permalink_url+'" target="_new"><img src="'+a[f].user.avatar_url.replace("large","badge")+'" alt="'+a[f].user.username+'" class="avatar"/></a>';var d='<a href="'+a[f].user.permalink_url+'" target="_new">'+a[f].user.username+"</a>";var e="";if(a[f].timestamp!==null){var g=Math.floor(Math.floor(a[f].timestamp/1e3)/60);var i=Math.floor(a[f].timestamp/1e3%60);if(i<10){i="0"+i}e='<span class="commentedat">at '+g+"."+i+"</span>"}var j=new Date(a[f].created_at);var k=new Date;var l=Math.floor((k.getTime()-j.getTime())/1e3);if(l<60){l=l+" seconds ago"}else if(l<2700){l=Math.round(l/60);if(l===1){l="1 minute ago"}else{l=l+" minutes ago"}}else if(l<86400){l=Math.round(l/(60*60));if(l===1){l="about 1 hour ago"}else{l="about "+l+" hours ago"}}else{l=Math.round(l/(60*60*24));if(l===1){l="1 day ago"}else{l=l+" days ago"}}var m='<span class="commented">'+l+"</span>";h=h+'<div class="acomment">'+b+d+" "+e+" "+m+'<div class="commentbody">'+a[f].body+"</div></div>"}h='<div class="addcomment"><h3>Add a new comment</h3><textarea id="newcomment"></textarea><input id="postcomment" type="submit" value="Post comment"/></div>'+h;c({sendlist:h})})}else if(a.requestlist.substring(0,11)==="postcomment"){inc=a.requestlist.split(",");var j="oauth_token="+localStorage.token+"&comment[body]="+inc[1];if(view==="inc"){incData[2][current]=0;e=incData[3][current]}else if(view==="fav"){favData[2][current]=0;e=favData[3][current]}else{miscData[2][current]=0;e=miscData[3][current]}d=new XMLHttpRequest;d.open("POST","https://api.soundcloud.com/tracks/"+e+"/comments.json",true);d.onreadystatechange=function(){if(d.readyState===4){c({sendlist:"posted"})}};d.setRequestHeader("Content-type","application/x-www-form-urlencoded");d.send(j)}else{c({})}})